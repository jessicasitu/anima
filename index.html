<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ANIMA - AI Reflective Companion</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --bg-primary: #f5f5f5;
  --bg-secondary: #ebebeb;
  --bg-card: rgba(255,255,255,0.7);
  --bg-input: rgba(0,0,0,0.03);
  --text-primary: #1a1a1a;
  --text-bold: #000000;
  --text-secondary: #4a4a4a;
  --text-muted: #888888;
  --accent: rgba(140,120,180,0.95);
  --accent-soft: rgba(140,120,180,0.7);
  --accent-bg: rgba(160,140,200,0.15);
  --accent-border: rgba(140,120,180,0.4);
  --border: rgba(0,0,0,0.08);
  --border-hover: rgba(0,0,0,0.15);
  --chart-line: rgba(120,100,160,0.6);
  --chart-baseline: rgba(0,0,0,0.1);
}

body {
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
  background: linear-gradient(160deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
  color: var(--text-primary);
  min-height: 100vh;
  line-height: 1.6;
}

.container { max-width: 540px; margin: 0 auto; padding: 20px; }

.header { text-align: center; padding: 40px 0 30px; border-bottom: 1px solid var(--border); margin-bottom: 30px; }
.logo { font-size: 2.8rem; font-weight: 300; letter-spacing: 0.35em; color: var(--text-bold); margin-bottom: 8px; }
.subtitle { font-size: 0.8rem; color: var(--text-muted); letter-spacing: 0.12em; text-transform: uppercase; font-weight: 500; }
.research-badge {
  display: inline-flex; align-items: center; gap: 8px; margin-top: 16px;
  padding: 6px 14px; background: rgba(0,0,0,0.04); border: 1px solid var(--border);
  border-radius: 20px; font-size: 0.65rem; letter-spacing: 0.1em; color: var(--text-secondary); font-weight: 500;
}
.badge-dot { width: 6px; height: 6px; background: var(--accent); border-radius: 50%; animation: pulse 2s infinite; }
@keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }

.section { margin-bottom: 28px; padding: 20px; background: var(--bg-card); border-radius: 14px; border: 1px solid var(--border); }
.section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
.section-title { font-size: 0.7rem; font-weight: 700; letter-spacing: 0.15em; text-transform: uppercase; color: var(--text-bold); }
.section-desc { font-size: 0.82rem; color: var(--text-muted); margin-bottom: 16px; line-height: 1.5; }

.cycle-options { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 8px; }
.cycle-option {
  padding: 14px 10px; background: rgba(255,255,255,0.6); border: 1px solid var(--border);
  border-radius: 10px; color: var(--text-secondary); cursor: pointer; transition: all 0.2s; text-align: center;
}
.cycle-option:hover { background: rgba(255,255,255,0.9); border-color: var(--border-hover); }
.cycle-option.selected { background: var(--accent-bg); border-color: var(--accent-border); color: var(--accent); }
.cycle-option .phase-name { font-weight: 700; font-size: 0.9rem; display: block; margin-bottom: 4px; color: var(--text-bold); }
.cycle-option.selected .phase-name { color: var(--accent); }
.cycle-option .phase-simple { font-size: 0.72rem; color: var(--text-muted); display: block; margin-bottom: 4px; font-style: italic; }
.cycle-option.selected .phase-simple { color: var(--accent-soft); }
.cycle-option .phase-e2 { font-size: 0.68rem; color: var(--text-muted); display: block; }
.cycle-option.selected .phase-e2 { color: var(--accent-soft); }

.e2-context { margin-top: 16px; padding: 14px; background: var(--bg-input); border-radius: 10px; font-size: 0.8rem; color: var(--text-secondary); line-height: 1.6; }
.e2-context strong { color: var(--text-bold); font-weight: 700; }

.e2-panel { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; margin-bottom: 16px; }
.e2-metric { text-align: center; }
.e2-metric-label { font-size: 0.65rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.08em; margin-bottom: 4px; font-weight: 600; }
.e2-metric-value { font-size: 1.6rem; font-weight: 300; color: var(--text-bold); }
.e2-metric-unit { font-size: 0.7rem; color: var(--text-muted); }

.e2-category { display: inline-block; padding: 3px 10px; background: rgba(0,0,0,0.05); border-radius: 12px; font-size: 0.75rem; color: var(--text-secondary); font-weight: 500; }
.e2-category.low { background: rgba(100,120,150,0.12); color: rgba(70,90,120,0.9); }
.e2-category.normal { background: rgba(100,100,100,0.1); color: var(--text-secondary); }
.e2-category.high { background: rgba(150,120,80,0.12); color: rgba(120,90,50,0.9); }
.e2-category.very-high { background: rgba(150,100,100,0.12); color: rgba(130,70,70,0.9); }

.chart-container { width: 100%; height: 100px; margin-top: 16px; border-radius: 8px; overflow: hidden; }
#e2Chart { width: 100%; height: 100%; }

.slider-group { margin-bottom: 18px; }
.slider-header { display: flex; justify-content: space-between; margin-bottom: 8px; }
.slider-label { font-size: 0.85rem; color: var(--text-bold); font-weight: 600; }
.slider-range { font-size: 0.7rem; color: var(--text-muted); }
input[type="range"] { width: 100%; height: 4px; -webkit-appearance: none; background: rgba(0,0,0,0.1); border-radius: 2px; outline: none; }
input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; width: 18px; height: 18px; background: var(--text-secondary); border-radius: 50%; cursor: pointer; transition: background 0.2s; }
input[type="range"]::-webkit-slider-thumb:hover { background: var(--accent); }

.chip-label { font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 10px; }
.mood-chips { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 16px; }
.mood-chip { padding: 8px 16px; background: rgba(255,255,255,0.7); border: 1px solid var(--border); border-radius: 18px; font-size: 0.85rem; color: var(--text-secondary); cursor: pointer; transition: all 0.2s; font-weight: 500; }
.mood-chip:hover { background: rgba(255,255,255,0.95); border-color: var(--border-hover); }
.mood-chip.selected { background: var(--accent-bg); border-color: var(--accent-border); color: var(--accent); font-weight: 600; }

.journal-header { font-size: 0.85rem; color: var(--text-bold); font-weight: 600; margin-bottom: 6px; }
.journal-subheader { font-size: 0.78rem; color: var(--text-muted); margin-bottom: 10px; }
.journal-input { width: 100%; padding: 14px; background: rgba(255,255,255,0.8); border: 1px solid var(--border); border-radius: 10px; color: var(--text-primary); font-size: 0.9rem; font-family: inherit; resize: vertical; min-height: 90px; }
.journal-input::placeholder { color: var(--text-muted); }
.journal-input:focus { outline: none; border-color: var(--accent-border); }

.btn-secondary { padding: 14px 16px; background: rgba(255,255,255,0.6); border: 1px solid var(--border); border-radius: 10px; color: var(--text-muted); font-size: 0.8rem; font-family: inherit; cursor: pointer; transition: all 0.2s; font-weight: 500; }
.btn-secondary:hover { background: rgba(255,255,255,0.9); border-color: var(--border-hover); }

.raf-link { background: none; border: none; color: var(--text-muted); font-size: 0.7rem; cursor: pointer; font-family: inherit; padding: 4px 0; transition: color 0.2s; }
.raf-link:hover { color: var(--accent); }

.btn-generate { width: 100%; padding: 14px 20px; background: var(--accent-bg); border: 1px solid var(--accent-border); border-radius: 10px; color: var(--accent); font-size: 0.9rem; font-family: inherit; cursor: pointer; transition: all 0.2s; font-weight: 600; margin-bottom: 20px; }
.btn-generate:hover:not(:disabled) { background: rgba(140,120,180,0.22); border-color: rgba(140,120,180,0.55); }
.btn-generate:disabled { opacity: 0.5; cursor: not-allowed; }

.loading { display: inline-flex; gap: 4px; align-items: center; }
.loading-dot { width: 6px; height: 6px; background: var(--accent); border-radius: 50%; animation: loadingPulse 1s infinite; }
.loading-dot:nth-child(2) { animation-delay: 0.2s; }
.loading-dot:nth-child(3) { animation-delay: 0.4s; }
@keyframes loadingPulse { 0%, 100% { opacity: 0.3; } 50% { opacity: 1; } }

.limit-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 1000; align-items: center; justify-content: center; }
.limit-modal.visible { display: flex; }
.limit-modal-content { background: white; padding: 32px; border-radius: 16px; max-width: 400px; text-align: center; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2); }
.limit-modal-title { font-size: 1.2rem; font-weight: 700; color: var(--text-bold); margin-bottom: 12px; }
.limit-modal-message { font-size: 0.9rem; color: var(--text-secondary); line-height: 1.6; margin-bottom: 24px; }
.limit-modal-btn { padding: 12px 24px; background: var(--accent); color: white; border: none; border-radius: 8px; font-size: 0.9rem; font-weight: 600; cursor: pointer; transition: all 0.2s; }
.limit-modal-btn:hover { background: rgba(140, 120, 180, 1); transform: translateY(-1px); }

#conversationThread { margin-top: 0; }

.chat-bubbles-container { display: flex; flex-direction: column; gap: 12px; margin-bottom: 16px; }

.reflection-bubble { padding: 16px; background: rgba(255, 255, 255, 0.8); border: 1px solid var(--border); border-radius: 12px; animation: fadeIn 0.3s ease; }
.reflection-bubble.user-bubble { background: rgba(140,120,180,0.08); border-left: 3px solid var(--accent); }
@keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }

.reflection-text { font-size: 0.95rem; line-height: 1.7; color: var(--text-primary); margin-bottom: 8px; }
.user-bubble .reflection-text { font-size: 0.9rem; }

.reflection-meta { display: flex; flex-wrap: wrap; gap: 8px; padding-top: 8px; border-top: 1px solid var(--border); margin-top: 8px; }
.meta-tag { font-size: 0.68rem; color: var(--text-muted); background: rgba(0, 0, 0, 0.04); padding: 3px 8px; border-radius: 4px; font-weight: 500; }

.reflection-feedback { display: flex; gap: 8px; align-items: center; padding: 8px 0; }
.feedback-label { font-size: 0.75rem; color: var(--text-muted); margin-right: 4px; }
.feedback-btn { padding: 6px 12px; background: rgba(255, 255, 255, 0.8); border: 1px solid var(--border); border-radius: 6px; font-size: 0.8rem; cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; gap: 4px; font-family: inherit; }
.feedback-btn:hover { background: rgba(255, 255, 255, 1); border-color: var(--border-hover); }
.feedback-btn.active.thumbs-up { background: rgba(100, 200, 100, 0.1); border-color: rgba(100, 200, 100, 0.4); color: #4a4; font-weight: 600; }
.feedback-btn.active.thumbs-down { background: rgba(200, 100, 100, 0.1); border-color: rgba(200, 100, 100, 0.4); color: #955; font-weight: 600; }

.single-reply-container { margin-top: 16px; padding: 16px; background: rgba(255,255,255,0.6); border: 1px solid var(--border); border-radius: 10px; }
.reply-label { font-size: 0.75rem; color: var(--text-muted); margin-bottom: 8px; font-weight: 600; }
.reply-input-group { display: flex; gap: 8px; align-items: flex-end; }
.reply-input { flex: 1; padding: 10px 12px; background: rgba(255, 255, 255, 0.9); border: 1px solid var(--border); border-radius: 8px; font-size: 0.85rem; font-family: inherit; color: var(--text-primary); resize: none; min-height: 42px; max-height: 120px; }
.reply-input::placeholder { color: var(--text-muted); }
.reply-input:focus { outline: none; border-color: var(--accent-border); }
.reply-btn { padding: 10px 16px; background: var(--accent-bg); border: 1px solid var(--accent-border); border-radius: 8px; color: var(--accent); font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: all 0.2s; white-space: nowrap; height: 42px; font-family: inherit; }
.reply-btn:hover:not(:disabled) { background: rgba(140, 120, 180, 0.22); border-color: rgba(140, 120, 180, 0.55); }
.reply-btn:disabled { opacity: 0.5; cursor: not-allowed; }

.session-history { margin-bottom: 16px; }
.session-history-header { font-size: 0.8rem; color: var(--text-bold); font-weight: 600; padding: 12px 16px; background: rgba(255, 255, 255, 0.6); border: 1px solid var(--border); border-radius: 10px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: all 0.2s; }
.session-history-header:hover { background: rgba(255, 255, 255, 0.8); }
.session-count { color: var(--text-muted); font-size: 0.75rem; font-weight: 400; }
.session-toggle { font-size: 0.7rem; color: var(--text-muted); }
.session-panel { display: none; padding: 16px; background: rgba(255, 255, 255, 0.5); border: 1px solid var(--border); border-top: none; border-radius: 0 0 10px 10px; max-height: 400px; overflow-y: auto; margin-top: -10px; }
.session-panel.visible { display: block; }
.session-empty { color: var(--text-muted); font-size: 0.8rem; font-style: italic; text-align: center; }
.session-list { display: flex; flex-direction: column; gap: 12px; }
.session-item { padding: 14px; background: rgba(255, 255, 255, 0.7); border: 1px solid var(--border); border-radius: 8px; }
.session-item.user-entry { background: rgba(140, 120, 180, 0.08); border-left: 3px solid var(--accent-soft); }
.session-item-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; font-size: 0.7rem; color: var(--text-muted); }
.session-item-source { font-size: 0.65rem; padding: 2px 6px; background: var(--accent-bg); border-radius: 4px; color: var(--accent); }
.session-item-text { font-size: 0.85rem; line-height: 1.6; color: var(--text-primary); }

.raf-panel { margin-top: 16px; padding: 18px; background: var(--bg-input); border-radius: 10px; font-size: 0.82rem; line-height: 1.6; display: none; }
.raf-panel.visible { display: block; animation: fadeIn 0.3s ease; }
.raf-panel h4 { color: var(--text-bold); margin-bottom: 10px; font-weight: 700; font-size: 0.9rem; }
.raf-panel p { color: var(--text-secondary); margin-bottom: 12px; line-height: 1.6; }
.raf-panel .raf-intro { font-size: 0.88rem; margin-bottom: 16px; }
.raf-panel .raf-intro em { color: var(--accent); font-style: italic; }
.raf-panel .raf-principle { margin-bottom: 14px; }
.raf-panel .raf-principle strong { color: var(--text-bold); font-weight: 700; display: block; margin-bottom: 4px; font-size: 0.85rem; }
.raf-panel .raf-principle p { font-size: 0.82rem; margin-bottom: 0; color: var(--text-secondary); }
.raf-panel .raf-footer { font-size: 0.8rem; color: var(--text-bold); margin-top: 16px; padding-top: 12px; border-top: 1px solid var(--border); }

.footer { text-align: center; padding: 30px 20px; font-size: 0.75rem; color: var(--text-muted); line-height: 1.6; }
.footer p { margin-bottom: 8px; }
.footer-credit { font-size: 0.7rem; margin-top: 12px; }
.complete-session { margin-bottom: 20px; padding: 16px; background: var(--accent-bg); border: 1px solid var(--accent-border); border-radius: 10px; text-align: center; }
.complete-message { font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 10px; }
.complete-btn { display: inline-block; padding: 12px 24px; background: var(--accent); color: white; border-radius: 8px; font-size: 0.85rem; font-weight: 600; text-decoration: none; transition: all 0.2s; }
.complete-btn:hover { background: rgba(140,120,180,1); transform: translateY(-1px); }

.error-message { padding: 12px 16px; margin: 10px 0; background: rgba(200, 100, 100, 0.1); border: 1px solid rgba(200, 100, 100, 0.3); border-radius: 8px; font-size: 0.85rem; color: #955; }

.hidden { display: none !important; }
  </style>
</head>
<body>
  <div class="container">
    <header class="header">
      <h1 class="logo">ANIMA</h1>
      <p class="subtitle">AI Reflective Companion</p>
      <div class="research-badge">
        <span class="badge-dot"></span>
        <span>RESEARCH PROTOTYPE</span>
      </div>
    </header>

    <section class="section" id="cycle-context">
      <h2 class="section-title">Cycle Context</h2>
      <p class="section-desc">Select where you are in your cycle. This helps ANIMA understand your hormonal context.</p>
      
      <div class="cycle-options" id="cycleOptions">
        <button class="cycle-option selected" data-phase="menstrual" data-baseline="40">
          <span class="phase-name">Menstrual</span>
          <span class="phase-simple">"On my period"</span>
          <span class="phase-e2">E2: ~20-60 pg/mL</span>
        </button>
        <button class="cycle-option" data-phase="follicular" data-baseline="80">
          <span class="phase-name">Follicular</span>
          <span class="phase-simple">"After my period"</span>
          <span class="phase-e2">E2: ~30-120 pg/mL</span>
        </button>
        <button class="cycle-option" data-phase="ovulatory" data-baseline="250">
          <span class="phase-name">Ovulatory</span>
          <span class="phase-simple">"Mid-cycle"</span>
          <span class="phase-e2">E2: ~100-400 pg/mL</span>
        </button>
        <button class="cycle-option" data-phase="luteal" data-baseline="130">
          <span class="phase-name">Luteal</span>
          <span class="phase-simple">"Before my next period"</span>
          <span class="phase-e2">E2: ~50-250 pg/mL</span>
        </button>
      </div>
      
      <div class="e2-context" id="cycleContext">
        <strong>Menstrual phase (days 1-5):</strong> Estradiol is typically at its lowest. Lower E2 can correlate with fatigue, lower mood, or a need for rest. This is physiologically normal.
      </div>
    </section>

    <section class="section" id="e2-sensing">
      <div class="section-header">
        <h2 class="section-title">E2 Sensing Layer (Simulated)</h2>
        <button id="toggleSimulator" class="btn-secondary" style="padding: 6px 12px; font-size: 0.7rem;">Pause</button>
      </div>
      <p class="section-desc">The simulator generates estradiol-like patterns based on your selected cycle phase. In a full system, this would come from a wearable biosensor.</p>
      
      <div class="e2-panel">
        <div class="e2-metric">
          <div class="e2-metric-label">Current E2</div>
          <div class="e2-metric-value" id="e2Value">--</div>
          <div class="e2-metric-unit">pg/mL</div>
        </div>
        <div class="e2-metric">
          <div class="e2-metric-label">Category</div>
          <div id="e2Category" class="e2-category">--</div>
        </div>
        <div class="e2-metric">
          <div class="e2-metric-label">Trend</div>
          <div id="e2Trend" class="e2-category">--</div>
        </div>
      </div>
      
      <div class="chart-container"><canvas id="e2Chart"></canvas></div>
    </section>

    <section class="section" id="self-report">
      <h2 class="section-title">Self-Report</h2>
      <p class="section-desc">These inputs help ANIMA calibrate its reflection to your current state. All fields are optional.</p>
      
      <p class="chip-label">How are you currently feeling? Select all that apply:</p>
      <div class="mood-chips" id="moodChips">
        <button class="mood-chip" data-mood="excited">üåü Excited</button>
        <button class="mood-chip" data-mood="motivated">üí™ Motivated</button>
        <button class="mood-chip" data-mood="calm">üòå Calm</button>
        <button class="mood-chip" data-mood="content">‚ò∫Ô∏è Content</button>
        <button class="mood-chip" data-mood="anxious">üò∞ Anxious</button>
        <button class="mood-chip" data-mood="irritable">üò§ Irritable</button>
        <button class="mood-chip" data-mood="tired">üò¥ Tired</button>
        <button class="mood-chip" data-mood="sad">üò¢ Sad</button>
      </div>
      
      <div class="slider-group">
        <div class="slider-header"><span class="slider-label">Energy</span><span class="slider-range">drained ‚Üî alive</span></div>
        <input type="range" id="energySlider" min="1" max="5" value="3">
      </div>
      <div class="slider-group">
        <div class="slider-header"><span class="slider-label">Stress</span><span class="slider-range">calm ‚Üî overwhelmed</span></div>
        <input type="range" id="stressSlider" min="1" max="5" value="3">
      </div>
      
      <div class="journal-header">Enter your journal entry (optional)</div>
      <div class="journal-subheader">What's present for you right now? Write as much or as little as feels right.</div>
      <textarea id="journalInput" class="journal-input" placeholder=""></textarea>
    </section>

    <section class="section" id="ai-reflection">
      <div class="section-header">
        <h2 class="section-title">Let's Reflect</h2>
        <button id="rafInfoBtn" class="raf-link">About RAF ‚Ä∫</button>
      </div>
      <p class="section-desc">ANIMA generates personalized reflections based on your cycle and self-report. All reflections follow the Reflective Agency Framework‚Äîno diagnoses, no prescriptions.</p>
      
      <div id="rafPanel" class="raf-panel">
        <h4>Reflective Agency Framework (RAF)</h4>
        <p class="raf-intro">ANIMA is built on the Reflective Agency Framework (Kim et al., 2025), designed to support self-understanding without undermining personal autonomy. The framework ensures AI-mediated reflection remains <em>yours</em>‚Äînot something imposed on you.</p>
        
        <div class="raf-principle">
          <strong>1. Internal Origination</strong>
          <p>Reflections only appear when <em>you</em> request them. ANIMA never pushes insights, notifications, or unsolicited advice. You remain the author of your own reflection process.</p>
        </div>
        
        <div class="raf-principle">
          <strong>2. Calibrated Responsiveness</strong>
          <p>The AI adapts its tone and content to your current state‚Äîyour E2 level, energy, sensitivity, and what you've shared. Low energy gets gentleness; high sensitivity gets care. The response meets you where you are.</p>
        </div>
        
        <div class="raf-principle">
          <strong>3. Reflective Ambiguity</strong>
          <p>ANIMA offers possibilities, not conclusions. Language like "might," "could," and "sometimes" keeps interpretations open. The AI ends with questions, not answers‚Äîinviting your own meaning-making rather than providing diagnoses.</p>
        </div>
        
        <div class="raf-principle">
          <strong>4. Transparency of Mediation</strong>
          <p>You always see what data informed the reflection‚Äîyour E2 reading, trend, cycle phase, and self-report. Nothing is hidden. You understand <em>why</em> the AI responded as it did.</p>
        </div>
        
        <div class="raf-principle">
          <strong>5. Self-Continuity</strong>
          <p>Reflections acknowledge your hormonal context without <em>reducing</em> you to it. You're a whole person with history, complexity, and agency‚Äînot just a data point. ANIMA supports your ongoing self-narrative.</p>
        </div>
        
        <p class="raf-footer">The goal is <strong>self-understanding</strong>, not self-management. Reflection over fixing. Curiosity over judgment.</p>
      </div>
      
      <button id="generateBtn" class="btn-generate">Generate Reflection</button>
      
      <div id="conversationThread">
        <div class="chat-bubbles-container" id="chatBubbles"></div>
        
        <div class="single-reply-container" id="replyContainer" style="display: none;">
          <div class="reply-label">Reply to ANIMA</div>
          <div class="reply-input-group">
            <textarea class="reply-input" id="replyInput" placeholder="Share your thoughts..." rows="1"></textarea>
            <button class="reply-btn" id="replyBtn">Send</button>
          </div>
        </div>
      </div>
    </section>

    <section class="section session-history">
      <div class="session-history-header" id="sessionToggle">
        <span>My Session <span class="session-count" id="sessionCount">(0)</span></span>
        <span class="session-toggle">‚ñº Show</span>
      </div>
      <div class="session-panel" id="sessionPanel">
        <div id="sessionList" class="session-list">
          <p class="session-empty">No reflections yet. Generate one to get started.</p>
        </div>
      </div>
    </section>

    <div id="limitModal" class="limit-modal">
      <div class="limit-modal-content">
        <h3 class="limit-modal-title">You've used all your reflections</h3>
        <p class="limit-modal-message">We hope ANIMA was helpful! We're working to make this more accessible soon. For now, please complete the post-survey to finish the study.</p>
        <button class="limit-modal-btn" onclick="closeLimitModal()">Got it</button>
      </div>
    </div>

    <footer class="footer">
      <div class="complete-session">
        <p class="complete-message">When you're ready, complete the post-survey to finish the study.</p>
        <a id="completeBtn" href="#" class="complete-btn">Complete Session ‚Üí</a>
      </div>
      
      <p>ANIMA is a research prototype exploring how AI can support embodied self-understanding without diagnosis or optimization.</p>
      <p class="footer-credit"><strong>Developed & Designed by Jess Adriana Rivera and Jessica Situ</strong></p>
    </footer>
  </div>

  <script>
    const GOOGLE_SHEETS_URL = 'https://script.google.com/macros/s/AKfycbyRbcJAbOGfkOBTJybhJWWFUXgdsNUsAf5h2p53TQMY96aSLRKqpB0j5_YPjtQe_lwBzg/exec';
    
    function generateVisitorId() {
      const timestamp = Date.now();
      const random = Math.random().toString(36).substr(2, 6).toUpperCase();
      return `ANIMA_${timestamp}_${random}`;
    }
    
    const visitorId = generateVisitorId();
    const urlParams = new URLSearchParams(window.location.search);
    const prolificPid = urlParams.get("PROLIFIC_PID");
    
    const Analytics = {
      sessionStart: Date.now(),
      firstReflectionTime: null,
      reflectionTimestamps: [],
      cyclePhaseChanges: 0,
      selfReportChanges: 0,
      e2ValueFirst: null,
      e2ValueLast: null,
      errorsEncountered: [],
      regenerateCount: 0,
      reflectionDismissals: 0,
      lastSelfReportState: null,
      dataSubmitted: false,
      selfReportHistory: [],
      cyclePhaseHistory: [],
      e2History: [],
      
      trackFirstReflection() {
        if (!this.firstReflectionTime) this.firstReflectionTime = Date.now();
        this.reflectionTimestamps.push(Date.now());
      },
      
      trackE2(value) {
        if (this.e2ValueFirst === null) this.e2ValueFirst = value;
        this.e2ValueLast = value;
        const lastLogged = this.e2History.length > 0 ? this.e2History[this.e2History.length - 1].value : null;
        if (lastLogged === null || Math.abs(value - lastLogged) >= 5) {
          this.e2History.push({ timestamp: new Date().toISOString(), value: value.toFixed(0) });
        }
      },
      
      trackCyclePhaseChange(phase) {
        this.cyclePhaseChanges++;
        this.cyclePhaseHistory.push({ timestamp: new Date().toISOString(), phase });
      },
      
      captureSelfReport(selfReport, cyclePhase, e2Value, reflectionIndex) {
        this.selfReportHistory.push({
          timestamp: new Date().toISOString(),
          reflectionIndex,
          cyclePhase,
          e2Value: e2Value ? e2Value.toFixed(0) : '',
          energy: selfReport.energy,
          stress: selfReport.stress,
          selectedMoods: [...selfReport.selectedMoods],
          journal: selfReport.journal
        });
      },
      
      trackSelfReportChange(newState) {
        const newStateStr = JSON.stringify(newState);
        if (this.lastSelfReportState && this.lastSelfReportState !== newStateStr) {
          this.selfReportChanges++;
        }
        this.lastSelfReportState = newStateStr;
      },
      
      trackError(error) {
        this.errorsEncountered.push({ time: new Date().toISOString(), error: error.toString() });
      },
      
      getSessionDuration() {
        return ((Date.now() - this.sessionStart) / 1000 / 60).toFixed(2);
      },
      
      getTimeToFirstReflection() {
        if (!this.firstReflectionTime) return '';
        return ((this.firstReflectionTime - this.sessionStart) / 1000).toFixed(1);
      },
      
      getAvgTimeBetweenReflections() {
        if (this.reflectionTimestamps.length < 2) return '';
        let total = 0;
        for (let i = 1; i < this.reflectionTimestamps.length; i++) {
          total += this.reflectionTimestamps[i] - this.reflectionTimestamps[i-1];
        }
        return (total / (this.reflectionTimestamps.length - 1) / 1000).toFixed(1);
      }
    };
    
    function getDeviceInfo() {
      const ua = navigator.userAgent;
      let deviceType = 'desktop';
      if (/Mobi|Android/i.test(ua)) deviceType = 'mobile';
      else if (/Tablet|iPad/i.test(ua)) deviceType = 'tablet';
      
      let browser = 'unknown';
      if (ua.includes('Chrome')) browser = 'Chrome';
      else if (ua.includes('Safari')) browser = 'Safari';
      else if (ua.includes('Firefox')) browser = 'Firefox';
      else if (ua.includes('Edge')) browser = 'Edge';
      
      return { deviceType, browser, screenWidth: window.innerWidth };
    }
    
    const sentReflections = new Set();
    const reflectionSnapshots = {};
    
    function sendReflectionData(reflectionNumber, aiResponse, selfReportAtTime, continuedThoughts = [], forceUpdate = false) {
      const reflectionKey = `${visitorId}_${reflectionNumber}`;
      const isUpdate = sentReflections.has(reflectionKey);
      
      if (isUpdate && continuedThoughts.length === 0 && !forceUpdate) {
        console.log('Skipping duplicate send for reflection', reflectionNumber);
        return;
      }
      
      const deviceInfo = getDeviceInfo();
      const sessionId = (prolificPid && prolificPid.length > 0) ? prolificPid : visitorId;
      const userContinuedCount = continuedThoughts.filter(t => !t.startsWith('[AI]:')).length;
      
      const data = {
        timestamp: new Date().toISOString(),
        sessionId: sessionId,
        sessionDuration: Analytics.getSessionDuration(),
        cyclePhase: selfReportAtTime.cyclePhase,
        energyLevel: selfReportAtTime.energy,
        stressLevel: selfReportAtTime.stress,
        selectedMoods: Array.isArray(selfReportAtTime.selectedMoods) ? selfReportAtTime.selectedMoods.join(', ') : selfReportAtTime.selectedMoods,
        journalEntry: selfReportAtTime.journal || '',
        reflectionNumber: reflectionNumber,
        resonated: forceUpdate ? (selfReportAtTime.resonated || '') : '',
        regenerateCount: Analytics.regenerateCount || 0,
        continuedThoughtsCount: userContinuedCount,
        e2Value: selfReportAtTime.e2Value || '',
        e2Trend: selfReportAtTime.e2Trend || '',
        aiReflectionText: aiResponse,
        continuedThoughts: continuedThoughts.join(' | '),
        deviceType: deviceInfo.deviceType,
        screenWidth: deviceInfo.screenWidth,
        browserType: deviceInfo.browser,
        isUpdate: isUpdate
      };
      
      sentReflections.add(reflectionKey);
      
      fetch(GOOGLE_SHEETS_URL, {
        method: 'POST',
        mode: 'no-cors',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      }).then(() => {
        console.log(`Reflection ${reflectionNumber} data sent (update: ${isUpdate})`);
      }).catch(err => {
        console.error('Error sending reflection data:', err);
      });
    }
    
    const CYCLE_CONTEXTS = {
      menstrual: {
        baseline: 40,
        description: '<strong>Menstrual phase (days 1-5):</strong> Estradiol is typically at its lowest. Lower E2 can correlate with fatigue, lower mood, or a need for rest. This is physiologically normal.',
        aiContext: 'User is in menstrual phase when estrogen is typically lowest. Fatigue, low mood, and need for rest are physiologically expected.'
      },
      follicular: {
        baseline: 80,
        description: '<strong>Follicular phase (days 6-13):</strong> Estradiol begins rising as follicles develop. Many experience gradually improving energy and mood during this phase.',
        aiContext: 'User is in follicular phase when estrogen is rising. Energy and mood often improve gradually during this time.'
      },
      ovulatory: {
        baseline: 250,
        description: '<strong>Ovulatory phase (days 14-16):</strong> Estradiol peaks around ovulation. Higher E2 is often associated with increased energy, heightened mood, and sometimes greater emotional sensitivity.',
        aiContext: 'User is in ovulatory phase when estrogen typically peaks. High energy and heightened emotional sensitivity are common.'
      },
      luteal: {
        baseline: 130,
        description: '<strong>Luteal phase (days 17-28):</strong> Estradiol is moderate but may fluctuate. Many experience variable mood, increased sensitivity, or PMS symptoms as the cycle progresses.',
        aiContext: 'User is in luteal phase when estrogen is moderate but variable. Mood fluctuations and increased sensitivity are common, especially in later luteal days.'
      }
    };
    
    let currentCyclePhase = 'menstrual';
    
    const E2Simulator = {
      series: [],
      baseline: 40,
      running: true,
      listeners: [],
      
      setBaseline(newBaseline) { this.baseline = newBaseline; },
      
      step() {
        let next;
        if (this.series.length === 0) {
          next = this.baseline + (Math.random() * 20 - 10);
        } else {
          const prev = this.series[this.series.length - 1].value;
          const drift = (this.baseline - prev) * 0.04;
          const shock = (Math.random() * 2 - 1) * 10;
          next = prev + drift + shock;
          if (Math.random() < 0.03) {
            next += (Math.random() < 0.5 ? -1 : 1) * (15 + Math.random() * 30);
          }
        }
        next = Math.max(15, Math.min(400, next));
        this.series.push({ t: Date.now(), value: next });
        if (this.series.length > 150) this.series = this.series.slice(-150);
        this.listeners.forEach(cb => cb(this.series));
      },
      
      start() {
        this.step();
        this.interval = setInterval(() => { if (this.running) this.step(); }, 2000);
      },
      
      toggle() {
        this.running = !this.running;
        return this.running;
      },
      
      onUpdate(cb) { this.listeners.push(cb); }
    };
    
    function extractFeatures(series, baseline) {
      if (!series || series.length === 0) {
        return { value: baseline, category: 'Normal', trend: 'Stable', delta10m: 0 };
      }
      const latest = series[series.length - 1];
      const value = latest.value;
      
      const targetTime = latest.t - 10 * 60 * 1000;
      let past = series[0];
      for (let i = series.length - 1; i >= 0; i--) {
        if (series[i].t <= targetTime) { past = series[i]; break; }
      }
      const delta10m = value - past.value;
      
      let category = 'Normal';
      if (value < 40) category = 'Low';
      else if (value > 200) category = 'Very High';
      else if (value > 120) category = 'High';
      
      let trend = 'Stable';
      if (delta10m > 5) trend = 'Rising';
      else if (delta10m < -5) trend = 'Falling';
      
      return { value, category, trend, delta10m };
    }
    
    const ConversationThread = {
      entries: [],
      lastContext: null,
      currentReflectionNum: 0,
      
      add(type, content, meta = {}) {
        const entry = {
          type,
          content,
          time: new Date().toLocaleTimeString(),
          timestamp: Date.now(),
          ...meta
        };
        this.entries.push(entry);
        return entry;
      },
      
      clear() {
        this.entries = [];
        this.lastContext = null;
      },
      
      setLastContext(context) {
        this.lastContext = JSON.stringify({
          cyclePhase: context.cyclePhase,
          energy: context.selfReport.energy,
          stress: context.selfReport.stress,
          moods: context.selfReport.selectedMoods
        });
      },
      
      hasContextChanged(newContext) {
        if (!this.lastContext) return false;
        const newSnap = JSON.stringify({
          cyclePhase: newContext.cyclePhase,
          energy: newContext.selfReport.energy,
          stress: newContext.selfReport.stress,
          moods: newContext.selfReport.selectedMoods
        });
        return this.lastContext !== newSnap;
      },
      
      getHistory() { return this.entries; },
      
      getForPrompt() {
        if (this.entries.length === 0) return '';
        return this.entries.map((e, i) => {
          if (e.type === 'user') {
            return `[User's response #${Math.ceil((i+1)/2)}]: "${e.content}"`;
          } else {
            return `[ANIMA's reflection #${Math.ceil((i+1)/2)}]: "${e.content}"`;
          }
        }).join('\n\n');
      },
      
      getCount() {
        return this.entries.filter(e => e.type === 'reflection').length;
      }
    };
    


// ============================================
// ANIMA: AI Reflective Practice Prompt
// ============================================

async function generateAIReflection(context, isFollowUp = false, userJustSaid = null) {
  const { features, selfReport, cyclePhase } = context;
  const cycleContext = CYCLE_CONTEXTS[cyclePhase];
  
  const energyWords = ['drained', 'low', 'moderate', 'good', 'energized'];
  const stressWords = ['calm', 'slightly tense', 'moderate stress', 'stressed', 'overwhelmed'];
  
  const moodsText = selfReport.selectedMoods.length > 0
    ? selfReport.selectedMoods.join(', ')
    : 'not specified';
  
  const conversationHistory = ConversationThread.getForPrompt();
  const conversationCount = ConversationThread.getCount();
  
  // PRACTICE-CENTERED SYSTEM PROMPT
  const systemPrompt = `You are ANIMA, a guide in the practice of cycle self-reflection. Your role is to help people develop their own capacity for insight, awareness, and understanding‚Äînot to provide answers or diagnoses.

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
WHAT IS REFLECTIVE PRACTICE?
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

Reflection is a skill that deepens with practice. It requires:
‚Ä¢ Awareness - noticing what's present without judgment
‚Ä¢ Willingness - opening to what you discover
‚Ä¢ Curiosity - asking questions rather than seeking certainty
‚Ä¢ Critical thinking - examining patterns and connections
‚Ä¢ Empathy - approaching your experience with kindness
‚Ä¢ Depth - moving beyond surface reactions to deeper understanding

You are here to cultivate these capacities in the person practicing with you.

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
YOUR ROLE AS GUIDE (NOT COMPANION):
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

‚úÖ You GUIDE their practice of reflection
‚úÖ You ASK questions that deepen awareness
‚úÖ You OFFER frameworks for understanding
‚úÖ You SUPPORT their capacity to notice and name
‚úÖ You STRENGTHEN their reflective skills over time

‚ùå You DON'T do the reflection for them
‚ùå You DON'T tell them what to conclude
‚ùå You DON'T diagnose or prescribe
‚ùå You DON'T become a substitute for their own insight

Think of yourself as a mentor who teaches someone to fish, not someone who provides fish.

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
CORE PRACTICE PRINCIPLES:
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

1. CENTER THEIR AGENCY
   The practice belongs to them. They are developing their skill.
   Your questions help them reflect more deeply on their own.

2. BUILD REFLECTIVE CAPACITY
   Each interaction should strengthen their ability to:
   - Notice patterns themselves
   - Name their experiences
   - Connect physical and emotional states
   - Hold complexity without rushing to conclusions

3. TEACH FRAMEWORKS, NOT FACTS
   Give them ways to think about their experience:
   - "One way to think about this is..."
   - "Some people find it helpful to consider..."
   - "A framework that might be useful..."

4. HONOR THE PROCESS
   Reflection isn't about getting "right answers."
   It's about developing awareness, curiosity, and self-understanding.

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
THE REFLECTIVE PRACTICE APPROACH:
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

1. INVITE AWARENESS (help them notice)
   "You mentioned feeling exhausted but also restless"
   
2. OFFER A LENS (give them a framework to work with)
   "That pairing‚Äîexhausted but restless‚Äîoften shows up when stress hormones are running high while your energy is depleted"
   
3. CONNECT TO CONTEXT (help them see the bigger picture)
   "This could be related to late luteal, when your body is in a high-alert state despite being drained"
   
4. DEEPEN INQUIRY (ask a question that builds their reflective skill)
   "What do you notice about where that restlessness lives‚Äîin your mind, your body, or both?"

The question should make them MORE capable of reflection, not just answering you.

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
QUESTIONS THAT BUILD REFLECTIVE CAPACITY:
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

Instead of surface questions:
‚ùå "How are you feeling?" (too broad)
‚ùå "Is it better today?" (yes/no, shallow)

Ask questions that develop awareness:
‚úÖ "What do you notice about where that feeling lives in your body?"
‚úÖ "How does this compare to the last time you felt this way?"
‚úÖ "What shifts when you pay attention to this experience?"
‚úÖ "What might this be telling you about what you need?"

Each question should teach them HOW to reflect, not just what to say.

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
LANGUAGE THAT SUPPORTS PRACTICE:
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

‚úÖ PRACTICE-CENTERED:
- "As you reflect on this..."
- "When you bring your attention to..."
- "What emerges when you sit with..."
- "The practice here is noticing..."

‚úÖ CAPACITY-BUILDING:
- "You're developing the skill of..."
- "This is strengthening your ability to..."
- "The awareness you're building here..."

‚úÖ EMPOWERING:
- "What do YOU notice about..."
- "How does this land for YOU..."
- "What feels true for YOU..."

‚ùå AVOID:
- "I notice you're..." (makes it about you, not their practice)
- "Let me tell you what's happening" (doing their work for them)
- "You should..." (prescriptive, not reflective)
- Companion language ("I'm here with you") - focus on their practice

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
CRITICAL GUIDELINES:
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

üî¥ NO QUOTES (paraphrase naturally)
   ‚ùå "You said 'I'm exhausted'"
   ‚úÖ "You mentioned feeling exhausted"

üî¥ NEVER DIAGNOSE (offer frameworks, not conclusions)
   ‚ùå "This IS anxiety"
   ‚úÖ "One way to think about this is as your nervous system responding to..."

üî¥ VARY YOUR APPROACH (different angles build different skills)
   Message 1: Help them NOTICE (awareness)
   Message 2: Help them CONNECT (patterns)
   Message 3: Help them CONTEXTUALIZE (timing/cycle)
   Message 4: Help them DEEPEN (nuance)

üî¥ BUILD THEIR CAPACITY (not dependence)
   Each response should make them MORE capable of self-reflection
   Not more dependent on you for insights

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
EXAMPLES OF PRACTICE-CENTERED RESPONSES:
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

User: "I'm exhausted but I can't relax"

‚úÖ GOOD (Practice-centered):
"You mentioned feeling exhausted but also restless‚Äîthat pairing often shows up when stress hormones are running high while your energy is depleted. This could be related to late luteal, when your body is in a high-alert state despite being drained. As you bring attention to this, what do you notice about where the restlessness lives‚Äîis it more in your thoughts, your physical sensations, or both?"

Why it works:
- Paraphrases their experience
- Offers a framework (stress hormones + energy)
- Connects to context (cycle phase)
- Asks a question that builds awareness skill
- Centers THEIR practice of noticing

User: "I'm anxious again" (second time)

‚úÖ GOOD (Practice-centered):
"Anxiety is showing up again‚Äîyou're developing the capacity to recognize when this surfaces. This part of your cycle can affect how your nervous system regulates itself. The practice here is noticing: does this anxiety have the same quality as before, or has something shifted?"

Why it works:
- Acknowledges their growing awareness
- Offers framework (nervous system regulation)
- Makes the question a "practice" of noticing
- Centers their developing skill

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
EDUCATIONAL FRAMEWORKS (Plain Language):
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

Offer these as "lenses" for understanding, not diagnoses:

‚Ä¢ Exhausted but restless ‚Üí "stress hormones running high while energy is depleted"
‚Ä¢ Anxiety + insomnia ‚Üí "these often amplify each other"
‚Ä¢ Energy crash after ovulation ‚Üí "estrogen drops after its peak"
‚Ä¢ Emotions feel bigger ‚Üí "hormones shifting can intensify feelings"
‚Ä¢ Physical and emotional connection ‚Üí "your body and emotional state are in conversation"

Always frame as: "One way to understand this..." or "A framework that might be useful..."

${isFollowUp ? 
  `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
FOLLOW-UP MODE (Continuing Practice):
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

They just responded. Continue supporting their practice:
1. Acknowledge what they noticed (builds confidence in their awareness)
2. Connect to what came before (shows pattern recognition)
3. Offer a framework if helpful (educate, don't diagnose)
4. Affirm their practice (they're developing skill)
5. NO question at end‚Äîclose by naming the capacity they're building

Example:
"Thank you for bringing attention to that. You mentioned feeling anxious earlier, and now you're noticing the calm after the walk‚Äîyou're developing awareness of what shifts your state. Movement can help regulate how your body responds to stress. This capacity to notice what helps is exactly the skill you're building."` : 
  `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
INITIAL REFLECTION MODE (Beginning Practice):
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

Support their practice of reflection:
1. Paraphrase their experience (no quotes)
2. If pattern exists, help them see it (pattern recognition skill)
3. Offer a framework for understanding (plain language)
4. Connect to cycle context (not as diagnosis)
5. End with a question that builds reflective capacity

Example structure:
"You mentioned [paraphrase]. One way to think about [description] is [plain language framework]. This could connect to [cycle phase context]. As you reflect on this, [question that builds awareness skill]?"`}

Cycle context: ${cycleContext.aiContext}

Keep it 3-4 sentences. Be warm, educational, and practice-focused. Support their developing capacity for self-reflection.`;
  
  // BUILD USER PROMPT
  let userPrompt = '';
  
  // CONVERSATION HISTORY
  if (conversationHistory && conversationCount > 0) {
    userPrompt += `CONVERSATION HISTORY (${conversationCount} messages):
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

${conversationHistory}

‚ö†Ô∏è BUILD DIFFERENT REFLECTIVE SKILLS: What capacity have you already developed?
- If you helped them NOTICE before ‚Üí now help them CONNECT patterns
- If you helped them CONNECT before ‚Üí now help them CONTEXTUALIZE to cycle
- If you helped them CONTEXTUALIZE before ‚Üí now help them DEEPEN nuance

Each message should strengthen a different aspect of their reflective practice.

`;
  }
  
  // CURRENT STATE
  userPrompt += `CURRENT STATE:
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

Phase: ${cyclePhase} (hormones: ${features.trend.toLowerCase()})
Moods: ${moodsText}
Energy: ${energyWords[selfReport.energy - 1]}
Stress: ${stressWords[selfReport.stress - 1]}`;
  
  // JOURNAL
  if (selfReport.journal && selfReport.journal.length > 0) {
    userPrompt += `

THEY WROTE:
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

"${selfReport.journal}"`;
  }
  
  // FOLLOW-UP vs INITIAL
  if (isFollowUp && userJustSaid) {
    userPrompt += `

THEY JUST RESPONDED:
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

"${userJustSaid}"

YOUR RESPONSE (continuing their practice):
1. Acknowledge what they noticed (affirm their awareness)
2. Connect to what came before
3. Offer framework if helpful (plain language)
4. Name the capacity they're building
5. NO question‚Äîclose by affirming their practice

3-4 sentences. Center their developing skill.`;
  } else {
    userPrompt += `

YOUR RESPONSE (support their practice):
1. Paraphrase their experience (no quotes)
2. If pattern exists, help them recognize it
3. Offer a framework for understanding (plain language, no jargon)
4. Connect to cycle context (not diagnosis)
5. End with question that builds awareness, critical thinking, or deeper inquiry

Formula: Paraphrase ‚Üí Framework ‚Üí Context ‚Üí Practice Question

3-4 sentences. Warm, educational, practice-centered. Build their reflective capacity.`;
  }
  
  try {
    const response = await fetch('/api/anthropic', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        systemPrompt: systemPrompt,
        userPrompt: userPrompt,
        maxTokens: 600
      })
    });
    
    if (!response.ok) {
      const errorData = await response.json().catch(() => ({}));
      console.error('API error:', response.status, errorData);
      throw new Error(`API error: ${response.status}`);
    }
    
    const data = await response.json();
    const text = data.reply || '';
    
    return {
      text: text || 'Unable to generate reflection.',
      source: 'ANIMA',
      isAI: true
    };
  } catch (error) {
    console.error('AI generation failed:', error);
    Analytics.trackError(error);
    return null;
  }
}

const chartCanvas = document.getElementById('e2Chart');
    const ctx = chartCanvas.getContext('2d');
    
    function drawChart(series, baseline) {
      const dpr = window.devicePixelRatio || 1;
      const rect = chartCanvas.getBoundingClientRect();
      chartCanvas.width = rect.width * dpr;
      chartCanvas.height = rect.height * dpr;
      ctx.scale(dpr, dpr);
      const width = rect.width;
      const height = rect.height;
      
      ctx.fillStyle = 'rgba(0,0,0,0.03)';
      ctx.fillRect(0, 0, width, height);
      
      if (!series || series.length === 0) return;
      
      const values = series.map(s => s.value);
      const minVal = Math.min(...values, baseline * 0.5) - 10;
      const maxVal = Math.max(...values, baseline * 1.5) + 10;
      const span = maxVal - minVal || 1;
      const padding = 6;
      
      const baseNorm = (baseline - minVal) / span;
      const baseY = height - padding - baseNorm * (height - padding * 2);
      ctx.strokeStyle = 'rgba(0,0,0,0.12)';
      ctx.lineWidth = 1;
      ctx.setLineDash([4, 4]);
      ctx.beginPath();
      ctx.moveTo(padding, baseY);
      ctx.lineTo(width - padding, baseY);
      ctx.stroke();
      ctx.setLineDash([]);
      
      ctx.strokeStyle = 'rgba(120,100,160,0.65)';
      ctx.lineWidth = 2;
      ctx.beginPath();
      series.forEach((s, i) => {
        const x = padding + (i / (series.length - 1 || 1)) * (width - padding * 2);
        const norm = (s.value - minVal) / span;
        const y = height - padding - norm * (height - padding * 2);
        if (i === 0) ctx.moveTo(x, y);
        else ctx.lineTo(x, y);
      });
      ctx.stroke();
    }
    
    function closeLimitModal() {
      document.getElementById('limitModal').classList.remove('visible');
    }
    
    function renderChatBubbles() {
      const container = document.getElementById('chatBubbles');
      const entries = ConversationThread.getHistory();
      
      container.innerHTML = entries.map((entry, idx) => {
        if (entry.type === 'user') {
          return `
            <div class="reflection-bubble user-bubble">
              <div class="reflection-text">${entry.content}</div>
              <div class="reflection-meta">
                <span class="meta-tag">You</span>
                <span class="meta-tag">${entry.time}</span>
              </div>
            </div>
          `;
        } else {
          return `
            <div class="reflection-bubble" data-reflection-idx="${idx}">
              <div class="reflection-text">${entry.content}</div>
              <div class="reflection-meta">
                <span class="meta-tag">E2: ${entry.e2Value || '--'} pg/mL</span>
                <span class="meta-tag">${entry.category || '--'}</span>
                <span class="meta-tag">${entry.trend || '--'}</span>
                <span class="meta-tag">Phase: ${entry.phase || '--'}</span>
              </div>
              <div class="reflection-feedback">
                <span class="feedback-label">Was this helpful?</span>
                <button class="feedback-btn thumbs-up" onclick="handleFeedback(${ConversationThread.currentReflectionNum}, true, ${idx})">
                  üëç Yes
                </button>
                <button class="feedback-btn thumbs-down" onclick="handleFeedback(${ConversationThread.currentReflectionNum}, false, ${idx})">
                  üëé Not really
                </button>
              </div>
            </div>
          `;
        }
      }).join('');
      
      const replyContainer = document.getElementById('replyContainer');
      if (entries.length > 0) {
        replyContainer.style.display = 'block';
      } else {
        replyContainer.style.display = 'none';
      }
    }
    
    function handleFeedback(reflectionNum, isPositive, entryIdx) {
      const bubble = document.querySelector(`[data-reflection-idx="${entryIdx}"]`);
      if (!bubble) return;
      
      const buttons = bubble.querySelectorAll('.feedback-btn');
      buttons.forEach(btn => btn.classList.remove('active'));
      
      const clickedBtn = bubble.querySelector(isPositive ? '.thumbs-up' : '.thumbs-down');
      clickedBtn.classList.add('active');
      
      if (isPositive) {
        resonanceData.resonates++;
      } else {
        resonanceData.doesntResonate++;
      }
      
      resonanceData.history.push({
        timestamp: new Date().toISOString(),
        resonated: isPositive,
        reflectionIndex: reflectionNum
      });
      
      if (reflectionSnapshots[reflectionNum]) {
        reflectionSnapshots[reflectionNum].resonated = isPositive ? 'yes' : 'no';
        sendReflectionData(
          reflectionNum,
          reflectionSnapshots[reflectionNum].aiResponse,
          reflectionSnapshots[reflectionNum],
          reflectionSnapshots[reflectionNum].continuedThoughts,
          true
        );
      }
      
      console.log('Feedback tracked for reflection', reflectionNum, ':', isPositive);
    }
    
    async function sendReply() {
      const input = document.getElementById('replyInput');
      const userResponse = input.value.trim();
      
      if (!userResponse) return;
      
      const btn = document.getElementById('replyBtn');
      btn.disabled = true;
      btn.innerHTML = '<span class="loading"><span class="loading-dot"></span><span class="loading-dot"></span><span class="loading-dot"></span></span>';
      
      ConversationThread.add('user', userResponse);
      
      const reflectionNum = ConversationThread.currentReflectionNum;
      if (reflectionSnapshots[reflectionNum]) {
        reflectionSnapshots[reflectionNum].continuedThoughts.push(userResponse);
      }
      
      renderChatBubbles();
      
      input.value = '';
      input.style.height = 'auto';
      
      const context = getCurrentContext();
      let result = await generateAIReflection(context, true, userResponse);
      
      if (!result) {
        result = {
          text: "Thank you for sharing that. What you're experiencing sounds meaningful.",
          source: 'Fallback',
          isAI: false
        };
      }
      
      ConversationThread.add('reflection', result.text, {
        source: result.source,
        e2Value: context.features.value.toFixed(0),
        category: context.features.category,
        trend: context.features.trend,
        phase: context.cyclePhase
      });
      
      if (reflectionSnapshots[reflectionNum]) {
        reflectionSnapshots[reflectionNum].continuedThoughts.push(`[AI]: ${result.text}`);
        sendReflectionData(
          reflectionNum,
          reflectionSnapshots[reflectionNum].aiResponse,
          reflectionSnapshots[reflectionNum],
          reflectionSnapshots[reflectionNum].continuedThoughts
        );
      }
      
      updateSessionPanel();
      renderChatBubbles();
      
      btn.disabled = false;
      btn.textContent = 'Send';
      
      setTimeout(() => {
        const lastBubble = document.querySelector('#chatBubbles .reflection-bubble:last-child');
        if (lastBubble) {
          lastBubble.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
      }, 100);
    }
    
    let currentFeatures = null;
    let selectedMoods = [];
    
    document.getElementById('sessionToggle').addEventListener('click', () => {
      const panel = document.getElementById('sessionPanel');
      const toggle = document.querySelector('.session-toggle');
      
      if (panel.classList.contains('visible')) {
        panel.classList.remove('visible');
        toggle.textContent = '‚ñº Show';
      } else {
        panel.classList.add('visible');
        toggle.textContent = '‚ñ≤ Hide';
      }
    });
    
    document.getElementById('cycleOptions').addEventListener('click', (e) => {
      const option = e.target.closest('.cycle-option');
      if (!option) return;
      
      const previousPhase = currentCyclePhase;
      
      document.querySelectorAll('.cycle-option').forEach(o => o.classList.remove('selected'));
      option.classList.add('selected');
      
      currentCyclePhase = option.dataset.phase;
      const newBaseline = parseInt(option.dataset.baseline);
      E2Simulator.setBaseline(newBaseline);
      E2Simulator.baseline = newBaseline;
      
      document.getElementById('cycleContext').innerHTML = CYCLE_CONTEXTS[currentCyclePhase].description;
      
      if (previousPhase !== currentCyclePhase) {
        Analytics.trackCyclePhaseChange(currentCyclePhase);
      }
    });
    
    E2Simulator.onUpdate(series => {
      currentFeatures = extractFeatures(series, E2Simulator.baseline);
      document.getElementById('e2Value').textContent = currentFeatures.value.toFixed(0);
      
      Analytics.trackE2(currentFeatures.value);
      
      const catEl = document.getElementById('e2Category');
      catEl.textContent = currentFeatures.category;
      catEl.className = 'e2-category ' + currentFeatures.category.toLowerCase().replace(' ', '-');
      
      document.getElementById('e2Trend').textContent = currentFeatures.trend;
      drawChart(series, E2Simulator.baseline);
    });
    
    document.getElementById('toggleSimulator').addEventListener('click', (e) => {
      const running = E2Simulator.toggle();
      e.target.textContent = running ? 'Pause' : 'Resume';
    });
    
    document.getElementById('moodChips').addEventListener('click', (e) => {
      if (e.target.classList.contains('mood-chip')) {
        const mood = e.target.dataset.mood;
        
        if (e.target.classList.contains('selected')) {
          e.target.classList.remove('selected');
          selectedMoods = selectedMoods.filter(m => m !== mood);
        } else {
          e.target.classList.add('selected');
          selectedMoods.push(mood);
        }
      }
    });
    
    const MAX_REFLECTIONS = 5;
    let reflectionsUsed = 0;
    
    function updateSessionPanel() {
      const entries = ConversationThread.getHistory();
      const reflectionCount = entries.filter(e => e.type === 'reflection').length;
      
      document.getElementById('sessionCount').textContent = `(${reflectionCount})`;
      
      const list = document.getElementById('sessionList');
      if (entries.length === 0) {
        list.innerHTML = '<p class="session-empty">No reflections yet. Generate one to get started.</p>';
        return;
      }
      
      list.innerHTML = entries.map((entry) => {
        if (entry.type === 'user') {
          return `
            <div class="session-item user-entry">
              <div class="session-item-header">
                <span>üí≠ Your Response</span>
                <span>${entry.time}</span>
              </div>
              <p class="session-item-text">${entry.content}</p>
            </div>
          `;
        } else {
          return `
            <div class="session-item">
              <div class="session-item-header">
                <span>üíú ANIMA</span>
                <span class="session-item-source">${entry.source || 'AI'}</span>
              </div>
              <p class="session-item-text">${entry.content}</p>
            </div>
          `;
        }
      }).join('');
    }
    
    document.getElementById('rafInfoBtn').addEventListener('click', () => {
      document.getElementById('rafPanel').classList.toggle('visible');
    });
    
    function getCurrentSelfReport() {
      return {
        energy: parseInt(document.getElementById('energySlider').value),
        stress: parseInt(document.getElementById('stressSlider').value),
        journal: document.getElementById('journalInput').value.trim(),
        selectedMoods: selectedMoods.length > 0 ? selectedMoods : []
      };
    }
    
    function getCurrentContext() {
      return {
        features: currentFeatures,
        selfReport: getCurrentSelfReport(),
        cyclePhase: currentCyclePhase
      };
    }
    
    document.getElementById('generateBtn').addEventListener('click', async () => {
      if (!currentFeatures) return;
      
      if (reflectionsUsed >= MAX_REFLECTIONS) {
        document.getElementById('limitModal').classList.add('visible');
        return;
      }
      
      const btn = document.getElementById('generateBtn');
      btn.disabled = true;
      btn.innerHTML = '<span class="loading"><span class="loading-dot"></span><span class="loading-dot"></span><span class="loading-dot"></span></span>';
      
      const context = getCurrentContext();
      
      if (ConversationThread.hasContextChanged(context) && ConversationThread.getHistory().length > 0) {
        console.log('Context changed - moving old chat to session history');
        updateSessionPanel();
        ConversationThread.clear();
      }
      
      Analytics.trackSelfReportChange(context.selfReport);
      Analytics.captureSelfReport(
        context.selfReport,
        context.cyclePhase,
        context.features ? context.features.value : null,
        reflectionsUsed + 1
      );
      
      let result = await generateAIReflection(context, false, null);
      
      if (!result) {
        Analytics.trackError('AI generation failed');
        document.getElementById('chatBubbles').innerHTML += `
          <div class="error-message">
            Unable to connect to AI. Please check your connection and try again.
          </div>
        `;
        btn.disabled = false;
        btn.textContent = 'Try Again';
        return;
      }
      
      Analytics.trackFirstReflection();
      
      reflectionsUsed++;
      ConversationThread.currentReflectionNum = reflectionsUsed;
      
      ConversationThread.add('reflection', result.text, {
        source: result.source,
        e2Value: context.features.value.toFixed(0),
        category: context.features.category,
        trend: context.features.trend,
        phase: context.cyclePhase
      });
      ConversationThread.setLastContext(context);
      
      updateSessionPanel();
      
      reflectionSnapshots[reflectionsUsed] = {
        cyclePhase: context.cyclePhase,
        energy: context.selfReport.energy,
        stress: context.selfReport.stress,
        selectedMoods: [...context.selfReport.selectedMoods],
        journal: context.selfReport.journal,
        e2Value: context.features ? context.features.value.toFixed(0) : '',
        e2Trend: context.features ? context.features.trend : '',
        aiResponse: result.text,
        continuedThoughts: [],
        resonated: ''
      };
      
      sendReflectionData(reflectionsUsed, result.text, reflectionSnapshots[reflectionsUsed]);
      
      renderChatBubbles();
      
      if (reflectionsUsed >= MAX_REFLECTIONS) {
        btn.disabled = true;
        btn.textContent = 'Limit Reached';
        setTimeout(() => {
          document.getElementById('limitModal').classList.add('visible');
        }, 500);
      } else {
        btn.disabled = false;
        btn.textContent = 'Generate New Reflection';
      }
    });
    
    const resonanceData = {
      resonates: 0,
      doesntResonate: 0,
      history: []
    };
    
    document.getElementById('replyInput').addEventListener('input', function() {
      this.style.height = 'auto';
      this.style.height = (this.scrollHeight) + 'px';
    });
    
    document.getElementById('replyBtn').addEventListener('click', sendReply);
    
    document.getElementById('replyInput').addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendReply();
      }
    });
    
    const completeBtn = document.getElementById("completeBtn");
    if (completeBtn) {
      completeBtn.addEventListener('click', async (e) => {
        e.preventDefault();
        
        if (Analytics.dataSubmitted) {
          if (prolificPid) {
            window.location.href = `https://mit.co1.qualtrics.com/jfe/form/SV_0JuC9TggUE1uHnU?PROLIFIC_PID=${encodeURIComponent(prolificPid)}`;
          } else {
            window.location.href = 'https://mit.co1.qualtrics.com/jfe/form/SV_0JuC9TggUE1uHnU';
          }
          return;
        }
        Analytics.dataSubmitted = true;
        
        const deviceInfo = getDeviceInfo();
        const selfReport = getCurrentSelfReport();
        const conversationHistory = ConversationThread.getHistory();
        
        const data = {
          visitorId: visitorId,
          prolificPid: (prolificPid && prolificPid.length > 0) ? prolificPid : visitorId,
          sessionDuration: Analytics.getSessionDuration(),
          cyclePhase: currentCyclePhase,
          energyLevel: selfReport.energy,
          stressLevel: selfReport.stress,
          selectedMoods: selfReport.selectedMoods.join(', '),
          journalEntry: selfReport.journal,
          reflectionsGenerated: reflectionsUsed,
          resonatesCount: resonanceData.resonates,
          doesntResonateCount: resonanceData.doesntResonate,
          regenerateCount: Analytics.regenerateCount,
          conversationContinues: conversationHistory.filter(e => e.type === 'user').length,
          e2ValueFirst: Analytics.e2ValueFirst ? Analytics.e2ValueFirst.toFixed(0) : '',
          e2ValueLast: Analytics.e2ValueLast ? Analytics.e2ValueLast.toFixed(0) : '',
          e2Trend: currentFeatures ? currentFeatures.trend : '',
          allReflectionTexts: conversationHistory.filter(e => e.type === 'reflection').map(e => e.content),
          allUserResponses: conversationHistory.filter(e => e.type === 'user').map(e => e.content),
          resonanceHistory: resonanceData.history,
          fullConversationThread: conversationHistory,
          timeToFirstReflection: Analytics.getTimeToFirstReflection(),
          avgTimeBetweenReflections: Analytics.getAvgTimeBetweenReflections(),
          cyclePhaseChanges: Analytics.cyclePhaseChanges,
          selfReportChanges: Analytics.selfReportChanges,
          journalWordCount: selfReport.journal ? selfReport.journal.split(/\s+/).filter(w => w).length : 0,
          userResponseWordCounts: conversationHistory.filter(e => e.type === 'user').map(e => e.content.split(/\s+/).filter(w => w).length),
          deviceType: deviceInfo.deviceType,
          screenWidth: deviceInfo.screenWidth,
          browserType: deviceInfo.browser,
          errorsEncountered: Analytics.errorsEncountered,
          completedSession: true,
          selfReportHistory: Analytics.selfReportHistory,
          cyclePhaseHistory: Analytics.cyclePhaseHistory,
          e2History: Analytics.e2History
        };
        
        fetch(GOOGLE_SHEETS_URL, {
          method: 'POST',
          mode: 'no-cors',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        }).then(() => {
          console.log('Data sent to Google Sheets');
        }).catch(err => {
          console.error('Fetch error:', err);
        });
        
        setTimeout(() => {
          if (prolificPid) {
            window.location.href = `https://mit.co1.qualtrics.com/jfe/form/SV_0JuC9TggUE1uHnU?PROLIFIC_PID=${encodeURIComponent(prolificPid)}`;
          } else {
            window.location.href = 'https://mit.co1.qualtrics.com/jfe/form/SV_0JuC9TggUE1uHnU';
          }
        }, 300);
      });
    }
    
    E2Simulator.start();
    updateSessionPanel();
  </script>
</body>
</html>
